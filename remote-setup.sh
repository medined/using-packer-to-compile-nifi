#!/bin/bash

#
# https://github.com/hashicorp/learn-terraform-provisioning/blob/packer/scripts/setup.sh
#

set -x

# ..######...######..##.....##
# .##....##.##....##.##.....##
# .##.......##.......##.....##
# ..######...######..#########
# .......##.......##.##.....##
# .##....##.##....##.##.....##
# ..######...######..##.....##

sudo mkdir -p /home/centos/.ssh
sudo chmod 700 /home/centos/.ssh
sudo cp /tmp/tf-packer.pem.pub /home/centos/.ssh/authorized_keys
sudo chmod 600 /home/centos/.ssh/authorized_keys
sudo chown -R centos /home/centos/.ssh

# ....###....##......##..######..  ....######..##.......####
# ...##.##...##..##..##.##....##.  ...##....##.##........##.
# ..##...##..##..##..##.##.......  ...##.......##........##.
# .##.....##.##..##..##..######..  ...##.......##........##.
# .#########.##..##..##.......##.  ...##.......##........##.
# .##.....##.##..##..##.##....##.  ...##....##.##........##.
# .##.....##..###..###...######..  ....######..########.####

sudo yum update -y
sudo yum install -y epel-release
sudo yum install -y awscli 

# .##.....##.########.####.##.......####.########.####.########..######.
# .##.....##....##.....##..##........##.....##.....##..##.......##....##
# .##.....##....##.....##..##........##.....##.....##..##.......##......
# .##.....##....##.....##..##........##.....##.....##..######....######.
# .##.....##....##.....##..##........##.....##.....##..##.............##
# .##.....##....##.....##..##........##.....##.....##..##.......##....##
# ..#######.....##....####.########.####....##....####.########..######.

sudo yum install -y git uuid

# .########..##....##.########.##.....##..#######..##....##
# .##.....##..##..##.....##....##.....##.##.....##.###...##
# .##.....##...####......##....##.....##.##.....##.####..##
# .########.....##.......##....#########.##.....##.##.##.##
# .##...........##.......##....##.....##.##.....##.##..####
# .##...........##.......##....##.....##.##.....##.##...###
# .##...........##.......##....##.....##..#######..##....##

#   Must add /usr/local/bin to the PATH.
#
sudo yum install -y python3
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
sudo python3 get-pip.py
rm get-pip.py
sudo python3 -m pip install boto boto3

# .##.......##....##.##....##.####..######.
# .##........##..##..###...##..##..##....##
# .##.........####...####..##..##..##......
# .##..........##....##.##.##..##...######.
# .##..........##....##..####..##........##
# .##..........##....##...###..##..##....##
# .########....##....##....##.####..######.

sudo yum install -y lynis

cat <<EOF > run-lynis-audit.sh
sudo lynis audit system --quick
EOF

chmod +x ./run-lynis-audit.sh

# ..######...#######..########..######.
# .##....##.##.....##.##.......##....##
# .##..............##.##.......##......
# ..######...#######..######....######.
# .......##........##.##.............##
# .##....##.##.....##.##.......##....##
# ..######...#######..##........######.

sudo yum install -y s3fs-fuse
mkdir -p $HOME/data
echo "s3fs $(cat /tmp/s3fs-bucket.txt) $HOME/data -o nonempty -o iam_role=auto" >> ~/.bashrc

# .......##....###....##.....##....###...
# .......##...##.##...##.....##...##.##..
# .......##..##...##..##.....##..##...##.
# .......##.##.....##.##.....##.##.....##
# .##....##.#########..##...##..#########
# .##....##.##.....##...##.##...##.....##
# ..######..##.....##....###....##.....##

sudo yum install -y maven

# ....###....########.....###.....######..##.....##.########....##....##.####.########.####
# ...##.##...##.....##...##.##...##....##.##.....##.##..........###...##..##..##........##.
# ..##...##..##.....##..##...##..##.......##.....##.##..........####..##..##..##........##.
# .##.....##.########..##.....##.##.......#########.######......##.##.##..##..######....##.
# .#########.##........#########.##.......##.....##.##..........##..####..##..##........##.
# .##.....##.##........##.....##.##....##.##.....##.##..........##...###..##..##........##.
# .##.....##.##........##.....##..######..##.....##.########....##....##.####.##.......####

git config --global core.longpaths true
git config --global core.autocrlf false
git clone https://gitbox.apache.org/repos/asf/nifi.git
cd nifi
git checkout rel/nifi-1.12.0
mvn -T 2.0C clean install -DskipTests
# ls -lhd target/nifi*

#/data/projects/using-packer-to-install-nifi/nifi/nifi-assembly