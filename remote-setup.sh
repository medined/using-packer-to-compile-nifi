#!/bin/bash

#
# https://github.com/hashicorp/learn-terraform-provisioning/blob/packer/scripts/setup.sh
#

set -x

lsblk

df -h

# ..######...######..##.....##
# .##....##.##....##.##.....##
# .##.......##.......##.....##
# ..######...######..#########
# .......##.......##.##.....##
# .##....##.##....##.##.....##
# ..######...######..##.....##

sudo mkdir -p /home/centos/.ssh
sudo chmod 700 /home/centos/.ssh
sudo cp /tmp/tf-packer.pem.pub /home/centos/.ssh/authorized_keys
sudo chmod 600 /home/centos/.ssh/authorized_keys
sudo chown -R centos /home/centos/.ssh

# ....###....##......##..######..  ....######..##.......####
# ...##.##...##..##..##.##....##.  ...##....##.##........##.
# ..##...##..##..##..##.##.......  ...##.......##........##.
# .##.....##.##..##..##..######..  ...##.......##........##.
# .#########.##..##..##.......##.  ...##.......##........##.
# .##.....##.##..##..##.##....##.  ...##....##.##........##.
# .##.....##..###..###...######..  ....######..########.####

sudo yum update -y
sudo yum install -y epel-release
sudo yum install -y awscli

# .##.....##.########.####.##.......####.########.####.########..######.
# .##.....##....##.....##..##........##.....##.....##..##.......##....##
# .##.....##....##.....##..##........##.....##.....##..##.......##......
# .##.....##....##.....##..##........##.....##.....##..######....######.
# .##.....##....##.....##..##........##.....##.....##..##.............##
# .##.....##....##.....##..##........##.....##.....##..##.......##....##
# ..#######.....##....####.########.####....##....####.########..######.

sudo yum install -y git uuid

# .########..##....##.########.##.....##..#######..##....##
# .##.....##..##..##.....##....##.....##.##.....##.###...##
# .##.....##...####......##....##.....##.##.....##.####..##
# .########.....##.......##....#########.##.....##.##.##.##
# .##...........##.......##....##.....##.##.....##.##..####
# .##...........##.......##....##.....##.##.....##.##...###
# .##...........##.......##....##.....##..#######..##....##

#   Must add /usr/local/bin to the PATH.
#
sudo yum install -y python3
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
sudo python3 get-pip.py
rm get-pip.py
sudo python3 -m pip install boto boto3

# .##.......##....##.##....##.####..######.
# .##........##..##..###...##..##..##....##
# .##.........####...####..##..##..##......
# .##..........##....##.##.##..##...######.
# .##..........##....##..####..##........##
# .##..........##....##...###..##..##....##
# .########....##....##....##.####..######.

sudo yum install -y lynis

cat <<EOF > run-lynis-audit.sh
sudo lynis audit system --quick
EOF

chmod +x ./run-lynis-audit.sh

# ..######...#######..########..######.
# .##....##.##.....##.##.......##....##
# .##..............##.##.......##......
# ..######...#######..######....######.
# .......##........##.##.............##
# .##....##.##.....##.##.......##....##
# ..######...#######..##........######.

sudo yum install -y s3fs-fuse
mkdir -p $HOME/data
echo "s3fs $(cat /tmp/s3fs-bucket.txt) $HOME/data -o nonempty -o iam_role=auto" >> ~/.bashrc

# .......##....###....##.....##....###...
# .......##...##.##...##.....##...##.##..
# .......##..##...##..##.....##..##...##.
# .......##.##.....##.##.....##.##.....##
# .##....##.#########..##...##..#########
# .##....##.##.....##...##.##...##.....##
# ..######..##.....##....###....##.....##
sudo yum install -y java-1.8.0-openjdk java-1.8.0-openjdk-devel

# .##.....##....###....##.....##.########.##....##
# .###...###...##.##...##.....##.##.......###...##
# .####.####..##...##..##.....##.##.......####..##
# .##.###.##.##.....##.##.....##.######...##.##.##
# .##.....##.#########..##...##..##.......##..####
# .##.....##.##.....##...##.##...##.......##...###
# .##.....##.##.....##....###....########.##....##

# Installing maven from yum provides v3.0.5. We want something more recent.

curl -L -o maven.tgz http://mirror.cogentco.com/pub/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz
tar xfz maven.tgz
rm maven.tgz

cat <<EOF >>.bashrc
export JAVA_HOME=/usr/lib/jvm/jre-openjdk
export M2_HOME=/home/centos/apache-maven-3.6.3
export MAVEN_HOME=/home/centos/apache-maven-3.6.3
export PATH=$PATH:/home/centos/apache-maven-3.6.3/bin
EOF

source .bashrc

# ....###....########.....###.....######..##.....##.########....##....##.####.########.####
# ...##.##...##.....##...##.##...##....##.##.....##.##..........###...##..##..##........##.
# ..##...##..##.....##..##...##..##.......##.....##.##..........####..##..##..##........##.
# .##.....##.########..##.....##.##.......#########.######......##.##.##..##..######....##.
# .#########.##........#########.##.......##.....##.##..........##..####..##..##........##.
# .##.....##.##........##.....##.##....##.##.....##.##..........##...###..##..##........##.
# .##.....##.##........##.....##..######..##.....##.########....##....##.####.##.......####

git config --global core.longpaths true
git config --global core.autocrlf false
git clone https://gitbox.apache.org/repos/asf/nifi.git
cd nifi
git checkout rel/nifi-1.12.0
mvn -T 2.0C clean install -DskipTests | tee /tmp/apache-nifi-build.log

cp nifi/nifi-assembly/target/nifi-1.12.0-bin.tar.gz /data
